<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©</title>
  <meta name="theme-color" content="#4b1d9b"/>
  <style>
    :root{
      --accent:#4b1d9b; --accent2:#b41f7a; --stroke:#e5e7eb; --text:#0b1220; --muted:#6b7280;
    }
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f7f8fb;color:var(--text);margin:0}
    .wrap{max-width:680px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(17,24,39,.08)}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:6px 0;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));
         color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;direction:ltr}
    .ok{color:#16a34a} .err{color:#b91c1c}
    .hint{font-size:13px;color:#6b7280}
    code{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  </style>

  <!-- Firebase compat SDKs (Ø¢Ù…Ù†Ø© Ø¹Ù„Ù‰ HTTPS ÙÙ‚Ø·) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯/Ø§Ù„Ø±ÙØ¶333</h1>
      <p>Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØªÙˆØµÙŠÙ„ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ù…Ø­ÙØ¸ØªÙƒ.</p>
      <div class="row" style="margin:10px 0 12px">
        <button id="btn" class="btn">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
        <span id="status" class="hint">Ø¬Ø§Ù‡Ø²</span>
      </div>
      <div id="details" class="hint"></div>
      <div style="margin-top:12px">
        <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰ <b>HTTPS</b> Ø£Ùˆ <b>localhost</b>.</div>
      </div>
    </div>
  </div>

  <script>
  // ======== Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù† Ù„Ø²Ù… =========
  const firebaseConfig = {
    apiKey: "AIzaSyCHVcGostwCnIvJXsjX60xWWVqF_RAbzn4",
    authDomain: "medo-cf169.firebaseapp.com",
    projectId: "medo-cf169",
    storageBucket: "medo-cf169.firebasestorage.app",
    messagingSenderId: "265864107835",
    appId: "1:265864107835:web:0f78740bdc24f4661c091e",
    measurementId: "G-10R049D0BD"
  };
  const VAPID_PUBLIC_KEY = "BGgnHxk-2_nvCM8jjGRrg2VxWLq1cQkjnbSGjUE4i2-fxY_SBWqz2tjdQGkJnrq8HEHwzdM0UQRQHgZptgTKypc"; // Ù…Ù† Cloud Messaging
  const API_BASE = "http://172.17.177.46:3000/owner-api/v1";   // ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª (Ù‚Ø¯ ÙŠÙØ­Ø¸Ø± Ø¹Ù„Ù‰ ØµÙØ­Ø§Øª HTTPS)
  // =================================

  const $ = (id)=>document.getElementById(id);
  const btn = $("btn"), statusEl = $("status"), detailsEl = $("details");

  // Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø·: ?app_id=...&uid=...&redir=...
  const urlp = new URLSearchParams(location.search);
  const appId = urlp.get("app_id") || urlp.get("appId") || "";
  const uid   = urlp.get("uid")    || urlp.get("user_id") || "";
  const redir = urlp.get("redir")  || "";

  function logStatus(msg, cls=""){ statusEl.textContent = msg; statusEl.className = cls||"hint"; }
  function logDetails(obj){
    try{ detailsEl.innerHTML = "<pre class='mono' style='white-space:pre-wrap'>"+JSON.stringify(obj,null,2)+"</pre>"; }
    catch{ detailsEl.textContent = ""; }
  }

  // ØªØ­Ù‚Ù‚ Ù…Ø¨Ø¯Ø¦ÙŠ
  if (!appId || !uid){
    logStatus("Ù…ÙÙ‚ÙˆØ¯ app_id Ø£Ùˆ uid ÙÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©.", "err");
    btn.disabled = true;
  }

  // Firebase init (ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ø³Ù… Ø§Ù„Ù…ØªØºÙŠØ±)
  try{
    firebase.initializeApp(firebaseConfig);
  }catch(e){
    console.error(e);
    logStatus("ØªØ¹Ø°Ù‘Ø± ØªÙ‡ÙŠØ¦Ø© Firebase.", "err");
    btn.disabled = true;
  }
  const messaging = firebase.messaging();

  // ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ùˆ SW
  const canNotify = "Notification" in window;
  const canSW = "serviceWorker" in navigator;

  if (!canNotify || !canSW){
    logStatus("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Notifications Ø£Ùˆ Service Worker.", "err");
    btn.disabled = true;
  }

  // ØªØ­Ø°ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© HTTPS Ùˆ API_BASE Ø¹Ù„Ù‰ HTTP (Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„Ø·Ø©)
  if (location.protocol === "https:" && API_BASE.startsWith("http://")){
    logStatus("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ØµÙØ­Ø© HTTPS Ù„ÙƒÙ† Ø§Ù„Ø®Ø§Ø¯Ù… HTTP â€” Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Mixed Content).", "err");
  }

  // ØªØ³Ø¬ÙŠÙ„ SW Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø£ØµÙ„ (Ø§Ù„Ø¬Ø°Ø±)
  async function ensureSW(){
    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† sw ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¬Ø°Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£ØµÙ„ (Ø¶Ø¹ firebase-messaging-sw.js ÙÙŠ Ø§Ù„Ø¬Ø°Ø±)
    const reg = await navigator.serviceWorker.register("/firebase-messaging-sw.js");
    await navigator.serviceWorker.ready;
    return reg;
  }

  // Ø¬Ù„Ø¨ Ø£Ùˆ Ø·Ù„Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø«Ù… getToken
  async function getFcmToken(){
    // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
    const perm = await Notification.requestPermission();
    if (perm !== "granted") throw new Error("ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");

    // ØªØ³Ø¬ÙŠÙ„ SW
    const reg = await ensureSW();

    // Ø¬Ù„Ø¨ FCM token
    const token = await messaging.getToken({
      vapidKey: VAPID_PUBLIC_KEY,
      serviceWorkerRegistration: reg
    });
    if (!token) throw new Error("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ FCM token");

    return token;
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ø³ÙŠØ±ÙØ±Ùƒ Ù„Ø±Ø¨Ø· Ø§Ù„ØªÙˆØ¨ÙŠÙƒ user_${appId}_${uid}
  async function registerOnBackend(token){
    const url = new URL(API_BASE + "/register-fcm");
    url.searchParams.set("app_id", appId);
    const body = {
      user_id: uid,
      fcm_token: token,
      platform: "web",
      user_agent: navigator.userAgent || ""
    };
    const res = await fetch(url.toString(), {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    let j=null; try{ j=await res.json(); }catch{}
    if (!res.ok){
      throw new Error((j && j.message) || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ø¯Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…");
    }
    return j;
  }

  btn.onclick = async ()=>{
    btn.disabled = true; logStatus("... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„");
    try{
      const token = await getFcmToken();
      logStatus("ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ...");
      const resp = await registerOnBackend(token);
      logStatus("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­. Ø³ØªØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯/Ø§Ù„Ø±ÙØ¶.", "ok");
      logDetails({ token, backend: resp });

      // Ø±Ø¬ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      if (redir){
        setTimeout(()=>{ location.href = redir; }, 1200);
      }
    }catch(e){
      console.error(e);
      logStatus("Ø®Ø·Ø£: " + (e && e.message ? e.message : String(e)), "err");
      logDetails({ error: String(e) });
      btn.disabled = false;
    }
  };
  </script>
</body>
</html>
