<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©</title>
  <meta name="theme-color" content="#4b1d9b"/>
  <style>
    :root{
      --accent:#4b1d9b; --accent2:#b41f7a; --stroke:#e5e7eb; --text:#0b1220; --muted:#6b7280;
    }
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:#f7f8fb;color:var(--text);margin:0}
    .wrap{max-width:680px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(17,24,39,.08)}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:6px 0;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));
         color:#fff;border:0;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;direction:ltr}
    .ok{color:#16a34a} .err{color:#b91c1c}
    .hint{font-size:13px;color:#6b7280}
    code{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  </style>

  <!-- Firebase compat SDKs (HTTPS ÙÙ‚Ø·) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯/Ø§Ù„Ø±ÙØ¶55</h1>
      <p>Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØªÙˆØµÙŠÙ„ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ù…Ø­ÙØ¸ØªÙƒ.</p>
      <div class="row" style="margin:10px 0 12px">
        <button id="btn" class="btn">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
        <span id="status" class="hint">Ø¬Ø§Ù‡Ø²</span>
      </div>
      <div id="details" class="hint"></div>
      <div style="margin-top:12px">
        <div class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰ <b>HTTPS</b> Ø£Ùˆ <b>localhost</b>.</div>
      </div>
    </div>
  </div>

  <script>
  // ======== Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =========
  const firebaseConfig = {
    apiKey: "AIzaSyCHVcGostwCnIvJXsjX60xWWVqF_RAbzn4",
    authDomain: "medo-cf169.firebaseapp.com",
    projectId: "medo-cf169",
    storageBucket: "medo-cf169.firebasestorage.app",
    messagingSenderId: "265864107835",
    appId: "1:265864107835:web:0f78740bdc24f4661c091e",
    measurementId: "G-10R049D0BD"
  };
  const VAPID_PUBLIC_KEY = "BGgnHxk-2_nvCM8jjGRrg2VxWLq1cQkjnbSGjUE4i2-fxY_SBWqz2tjdQGkJnrq8HEHwzdM0UQRQHgZptgTKypc";
  const API_BASE = "https://frankfurt-contribute-featuring-regulated.trycloudflare.com/owner-api/v1"; // ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
  // =================================

  const $ = (id)=>document.getElementById(id);
  const btn = $("btn"), statusEl = $("status"), detailsEl = $("details");

  // Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø·: ?app_id=...&uid=...&redir=...
  const urlp  = new URLSearchParams(location.search);
  const appId = urlp.get("app_id") || urlp.get("appId") || "";
  const uid   = urlp.get("uid")    || urlp.get("user_id") || "";
  const redir = urlp.get("redir")  || "";

  function logStatus(msg, cls=""){ statusEl.textContent = msg; statusEl.className = cls||"hint"; }
  function logDetails(obj){
    try{ detailsEl.innerHTML = "<pre class='mono' style='white-space:pre-wrap'>"+JSON.stringify(obj,null,2)+"</pre>"; }
    catch{ detailsEl.textContent = ""; }
  }

  // ØªØ­Ù‚Ù‚ Ù…Ø¨Ø¯Ø¦ÙŠ
  if (!appId || !uid){
    logStatus("Ù…ÙÙ‚ÙˆØ¯ app_id Ø£Ùˆ uid ÙÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©.", "err");
    btn.disabled = true;
  }

  // Firebase init
  try{
    firebase.initializeApp(firebaseConfig);
  }catch(e){
    console.error(e);
    logStatus("ØªØ¹Ø°Ù‘Ø± ØªÙ‡ÙŠØ¦Ø© Firebase.", "err");
    btn.disabled = true;
  }
  const messaging = firebase.messaging();

  // Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­
  const canNotify = "Notification" in window;
  const canSW     = "serviceWorker" in navigator;
  if (!canNotify || !canSW){
    logStatus("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Notifications Ø£Ùˆ Service Worker.", "err");
    btn.disabled = true;
  }

  // ØªØ­Ø°ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ùˆ HTTPS + API_BASE = HTTP (Ù„Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ SW)
  if (location.protocol === "https:" && API_BASE.startsWith("http://")){
    console.warn("Mixed Content Ù…Ø­ØªÙ…Ù„ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù….");
  }

  // ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€Service Worker Ù…Ù† Ù†ÙØ³ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµÙØ­Ø© (/LS-wallet/) =====
  async function ensureSW(){
    // Ù†Ø¨Ù†ÙŠ basePath Ù…Ù† Ù…Ø³Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¹Ù„Ù‰ /LS-wallet/
    const basePath = location.pathname.endsWith('/')
      ? location.pathname
      : location.pathname.replace(/[^/]+$/, '/'); // .../LS-wallet/index.html -> .../LS-wallet/

    const swUrl = basePath + "firebase-messaging-sw.js?v=" + Date.now(); // Ù…Ù†Ø¹ ÙƒØ§Ø´ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
    const reg = await navigator.serviceWorker.register(swUrl, { scope: basePath });
    await navigator.serviceWorker.ready;
    console.log("SW registered at:", swUrl, "scope:", reg.scope);
    return reg;
  }

  // ===== Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø«Ù… getToken Ù…Ù† FCM =====
  async function getFcmToken(){
    const perm = await Notification.requestPermission();
    if (perm !== "granted") throw new Error("ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");

    const reg = await ensureSW();

    const token = await messaging.getToken({
      vapidKey: VAPID_PUBLIC_KEY,
      serviceWorkerRegistration: reg
    });
    if (!token) throw new Error("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ FCM token");
    return token;
  }

  // ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ø³ÙŠØ±ÙØ±Ùƒ =====
  async function registerOnBackend(token){
    const url = new URL(API_BASE + "/register-fcm");
    url.searchParams.set("app_id", appId);
    const body = {
      user_id: uid,
      fcm_token: token,
      platform: "web",
      user_agent: navigator.userAgent || ""
    };
    const res = await fetch(url.toString(), {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body)
    });
    let j=null; try{ j=await res.json(); }catch{}
    if (!res.ok) throw new Error((j && j.message) || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ø¯Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…");
    return j;
  }

  // ===== Ø­Ø¯Ø« Ø§Ù„Ø²Ø± =====
  btn.onclick = async ()=>{
    btn.disabled = true; logStatus("... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ¹ÙŠÙ„");
    try{
      const token = await getFcmToken();
      logStatus("ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ†ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ...");
      const resp = await registerOnBackend(token);
      logStatus("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­. Ø³ØªØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯/Ø§Ù„Ø±ÙØ¶.", "ok");
      logDetails({ token, backend: resp });
      if (redir){ setTimeout(()=>{ location.href = redir; }, 1200); }
    }catch(e){
      console.error(e);
      logStatus("Ø®Ø·Ø£: " + (e && e.message ? e.message : String(e)), "err");
      logDetails({ error: String(e) });
      btn.disabled = false;
    }
  };
  </script>
</body>
</html>

